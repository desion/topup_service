/*************************************************************************
	> File Name: TopupUtils.h
	> Author: desionwang
	> Mail: wdxin1322@qq.com 
	> Created Time: Sat 08 Feb 2014 02:38:15 PM CST
 ************************************************************************/

#ifndef __TOPUP_UTILS_H
#define __TOPUP_UTILS_H


#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "dllcall.h"
#include "TopupBase.h"

#define MAX_LOG_LEN  1024

//将日志写入缓冲区
#define TP_WRITE_LOG(info, fmt, ...) { \
	if(info->log_len < MAX_LOG_LEN){\
	    info->log_len += snprintf(info->log + info->log_len, MAX_LOG_LEN - info->log_len, fmt, ##__VA_ARGS__);\
	}\
}

//调用动态链接库方法
#define DLLCALL(so, call, ret, ...) {\
	    pthread_rwlock_rdlock(&so->lock);\
	    ret = so->call(__VA_ARGS__);\
	    pthread_rwlock_unlock(&so->lock);\
}

#define DLLCALL2(so, call, ...) {\
	    pthread_rwlock_rdlock(&so->lock);\
	    so->call(__VA_ARGS__);\
	    pthread_rwlock_unlock(&so->lock);\
}

#define CHECKNULL(var, fmt, ...) {\
	slog_write(LL_FATAL, fmt, ##__VA_ARGS__);\
	if(var == NULL){\
		return false;\
	}\
}
typedef struct ChannelInfo{
	int channelId;			//渠道ID
	string channelName;		//渠道名称
	string sname;			//渠道简称
	string interfaceName;	//接口标识
	int priority;			//优先级
	int repeat;				//重试次数
} ChannelInfo;

struct TopupInfo{
	string coopId;          //商家编号
    string tbOrderNo;       //淘宝的订单号
    string cardId;          //充值卡商品编号
    int cardNum;            //充值卡数量
    string customer;        //手机号码
    double sum;             //本次充值总金额
    string tbOrderSnap;     //商品信息快照
    string notifyUrl;       //异同通知地址
    string sign;            //签名字符串
    string version;         //版本
	double price;			//单价
	ChannelInfo channelInfo;
};


//动态库重加载指令
#define SO_RELOAD_CMD		100
//配置等重加载指令
#define CONF_RELOAD_CMD		101
//服务进入维护状态指令
#define SERVICE_STOP_CMD	102
//服务恢复指令
#define SERVICE_RESUME_CMD	103
//dump缓存数据指令
#define DUMP_CACHE_CMD		104

enum encoding{
	UTF8,
	GBK
};

typedef struct err_code{
	int code;
	char* msg;
}err_code;

typedef struct SoBase{
	void *handle;
	pthread_rwlock_t lock;
	char *filename;
	int file_time;
	int (*reload)(struct SoBase *so);
	TopupBase* (*create)();
	void (*destory)(TopupBase* topupBase);
} SoBase;


//初始化动态链接库加载，reload函数为动态链接库加载函数
int so_init(SoBase *so, char *filename, int (reload)(SoBase *so));
int so_change(SoBase *so, char *filename);
int so_check_reload(SoBase *so);
int so_load(SoBase *so);
int so_free(SoBase *so);
//动态链接库加载函数，主要是加载相应的函数
int so_topup_reload(SoBase *h);


inline int split_string (char * s, const char * seperator, std::vector<char *> & field_vec)
{
	field_vec.clear();
	if (s == NULL) return -1;
	if (seperator == NULL) return -1;

	int sep_len = strlen(seperator);
	char * p = s;
	field_vec.push_back(p);
	while ((p = strstr(p, seperator)) != NULL)
	{
		*p = '\0';
		p += sep_len;
		field_vec.push_back(p);
	}
	return field_vec.size();
}

#endif  //__TOPUP_UTILS_H
